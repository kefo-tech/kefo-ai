<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ - ÙˆØ§Ø¬Ù‡Ø© Ø¯Ø±Ø¯Ø´Ø© ØªÙ‚Ù†ÙŠØ©</title>

  <!-- Ø®Ø·ÙˆØ·: Ù„ÙŠÙ„ÙŠ (Ù…ÙˆÙ†Ùˆ) + Ù†Ù‡Ø§Ø±ÙŠ (ÙˆØ§Ø¶Ø­) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg: #000;
      --text: #0f0;
      --panel: rgba(0,0,0,0.85);
      --panel2: rgba(0,0,0,0.92);
      --border: #0f0;
      --bubble: rgba(0,128,0,0.2);
      --bubble-user: rgba(0,255,0,0.3);
      --shadow: 0 0 20px var(--border);
      --muted: rgba(0,255,0,0.75);
      --btn-bg: #000;
      --btn-text: #0f0;
      --btn-hover-bg: #0f0;
      --btn-hover-text: #000;
      --font: "Courier New", Courier, monospace;
    }

    /* ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ: Ø®Ø· ÙˆØ§Ø¶Ø­ + ØªØ¨Ø§ÙŠÙ† Ø£ÙØ¶Ù„ */
    body.theme-light{
      --bg: #f7f9ff;
      --text: #102a10;
      --panel: rgba(255,255,255,0.92);
      --panel2: rgba(255,255,255,0.97);
      --border: #153a15;
      --bubble: rgba(21,58,21,0.08);
      --bubble-user: rgba(21,58,21,0.12);
      --shadow: 0 10px 26px rgba(0,0,0,0.12);
      --muted: rgba(16,42,16,0.7);
      --btn-bg: #ffffff;
      --btn-text: #153a15;
      --btn-hover-bg: #153a15;
      --btn-hover-text: #ffffff;
      --font: "Cairo", "Inter", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      user-select: none;
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 720px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding: 10px;
      padding-bottom: 92px; /* Ù…Ø³Ø§Ø­Ø© Ø«Ø§Ø¨ØªØ© Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ fixed */
    }

    /* Ù‡ÙŠØ¯Ø± Ø£Ø¹Ù„Ù‰ */
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .header h1{
      margin: 0;
      font-size: 1.2rem;
      text-shadow: 0 0 10px var(--border), 0 0 20px var(--border);
      line-height: 1.2;
    }

    .header-actions{
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .icon-btn{
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--border);
      width: 40px;
      height: 40px;
      border-radius: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(0,255,0,0.15);
      transition: transform 0.12s ease, background 0.12s ease, color 0.12s ease;
      font-size: 18px;
    }
    .icon-btn:hover{
      background: var(--btn-hover-bg);
      color: var(--btn-hover-text);
      transform: scale(1.05);
    }

    /* Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
    #chat-container {
      margin-top: 10px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    #conversation {
      padding: 12px;
      background: var(--panel2);
      direction: rtl;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      scroll-behavior: smooth;
    }

    .message-bubble {
      background: var(--bubble);
      color: var(--text);
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin: 10px 0;
      max-width: 92%;
      word-wrap: break-word;
      line-height: 1.7;
    }

    .user-bubble {
      margin-right: auto;
      background: var(--bubble-user);
    }

    .article-container {
      padding: 14px;
      background: rgba(0, 128, 0, 0.08);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin: 12px 0;
    }
    body.theme-light .article-container{ background: rgba(21,58,21,0.06); }

    .signature {
      margin-top: 8px;
      font-size: 14px;
      color: var(--muted);
      text-align: left;
      font-style: italic;
    }

    .typing-effect {
      display: inline-block;
      white-space: pre-wrap;
    }

    .copy-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--border);
      padding: 9px 14px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 10px;
      margin-top: 12px;
      display: inline-block;
      transition: transform 0.12s ease, background 0.12s ease, color 0.12s ease;
    }
    .copy-btn:hover {
      background: var(--btn-hover-bg);
      color: var(--btn-hover-text);
      transform: scale(1.03);
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: Fixed (Ù„Ù† ÙŠØªØ­Ø±Ùƒ Ø£Ø¨Ø¯Ø§Ù‹) */
    #input-container {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 10px;
      width: calc(100% - 20px);
      max-width: 720px;
      z-index: 60;

      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    #userInput {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-text);
      caret-color: var(--border);
      outline: none;
    }

    #sendBtn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--border);
      padding: 12px 18px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      white-space: nowrap;
      transition: transform 0.12s ease, background 0.12s ease, color 0.12s ease;
    }
    #sendBtn:hover {
      background: var(--btn-hover-bg);
      color: var(--btn-hover-text);
      transform: scale(1.03);
    }

    /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    .notification {
      position: fixed;
      bottom: 110px; /* ÙÙˆÙ‚ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
      right: 20px;
      background: var(--border);
      color: var(--btn-hover-text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: var(--shadow);
      z-index: 200;
      transition: opacity 0.5s ease-in-out;
      max-width: calc(100% - 40px);
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    .settings-drawer{
      position: fixed;
      inset: 0;
      z-index: 100;
      display: none;
    }
    .settings-drawer.open{ display: block; }

    .settings-backdrop{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
    }

    .settings-panel{
      position: absolute;
      top: 12px;
      left: 12px;
      right: 12px;
      max-width: 720px;
      margin: 0 auto;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 12px;
    }

    .settings-panel h2{
      margin: 0 0 10px 0;
      font-size: 1.05rem;
    }

    .setting-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: var(--panel);
      margin-bottom: 10px;
    }

    .toggle{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    .toggle input{ display:none; }

    .toggle-pill{
      width: 54px;
      height: 30px;
      border-radius: 99px;
      border: 1px solid var(--border);
      background: var(--btn-bg);
      position: relative;
    }
    .toggle-pill::after{
      content: "";
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--border);
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      right: 3px;
      transition: right 0.2s ease;
    }
    .toggle input:checked + .toggle-pill::after{ right: 27px; }

    .btn{
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--border);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease, color 0.12s ease;
      font-size: 14px;
    }
    .btn:hover{
      background: var(--btn-hover-bg);
      color: var(--btn-hover-text);
      transform: scale(1.03);
    }

    .settings-footer{
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding-top: 6px;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ØºØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) */
    .lang-modal{
      position: fixed;
      inset: 0;
      z-index: 300;
      display: none;
      background: rgba(0,0,0,0.7);
    }
    .lang-modal.open{ display: grid; place-items: center; }

    .lang-card{
      width: calc(100% - 24px);
      max-width: 520px;
      background: var(--panel2);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .lang-card h3{
      margin: 0 0 10px 0;
      font-size: 1.05rem;
      line-height: 1.5;
    }

    .lang-grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .lang-btn{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }
    .lang-btn:hover{
      transform: scale(1.01);
      background: rgba(0,255,0,0.08);
    }
    body.theme-light .lang-btn:hover{
      background: rgba(21,58,21,0.08);
    }

    .lang-left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .flag{
      font-size: 20px;
      line-height: 1;
    }

    .lang-name{
      font-weight: 700;
    }
    .lang-code{
      font-size: 12px;
      opacity: 0.8;
    }

    @media (max-width: 600px) {
      .app{ padding: 8px; padding-bottom: 96px; }
      .header h1 { font-size: 1.05rem; }
      #sendBtn { padding: 12px 14px; font-size: 15px; }
      .message-bubble { max-width: 100%; font-size: 14px; }
      #input-container { bottom: 8px; width: calc(100% - 16px); }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <h1 id="appTitle">Ù…Ù†ØµØ© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ù„Ù…ÙŠ</h1>
      <div class="header-actions">
        <button class="icon-btn" id="settingsBtn" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" aria-label="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™ï¸</button>
      </div>
    </div>

    <audio id="background-music" preload="none" controls style="display:none">
      <source src="https://assets.mixkit.co/active_storage/sfx/2467/2467-preview.mp3" type="audio/mpeg" />
    </audio>

    <div id="chat-container">
      <div id="conversation"></div>
    </div>
  </div>

  <!-- Input fixed -->
  <div id="input-container">
    <input type="text" id="userInput" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø¬Ù…Ù„Ø© Ù„Ù„Ø¨Ø­Ø«" />
    <button id="sendBtn">Ø¨Ø­Ø«</button>
  </div>

  <!-- Settings Drawer -->
  <div class="settings-drawer" id="settingsDrawer" aria-hidden="true">
    <div class="settings-backdrop" id="settingsBackdrop"></div>
    <div class="settings-panel" role="dialog" aria-modal="true" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">
      <h2 id="settingsTitle">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

      <div class="setting-row">
        <div id="themeRowLabel">Ø§Ù„ÙˆØ¶Ø¹</div>
        <label class="toggle" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ">
          <input type="checkbox" id="themeToggle" />
          <span class="toggle-pill"></span>
          <span id="themeLabel">Ù„ÙŠÙ„ÙŠ</span>
        </label>
      </div>

      <div class="setting-row">
        <div id="langRowLabel">Ø§Ù„Ù„ØºØ©</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <span id="currentLangLabel" style="opacity:.9;"></span>
          <button class="btn" id="changeLangBtn">ØªØºÙŠÙŠØ±</button>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn" id="closeSettingsBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Language Modal (first run + settings) -->
  <div class="lang-modal" id="langModal">
    <div class="lang-card">
      <h3 id="langPrompt">Ø§Ø®ØªØ± Ù„ØºØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
      <div class="lang-grid">
        <button class="lang-btn" data-lang="ar">
          <div class="lang-left">
            <span class="flag">ğŸ‡µğŸ‡¸</span>
            <div>
              <div class="lang-name">Ø¹Ø±Ø¨ÙŠ</div>
              <div class="lang-code">Wikipedia: ar</div>
            </div>
          </div>
          <span>â†’</span>
        </button>

        <button class="lang-btn" data-lang="en">
          <div class="lang-left">
            <span class="flag">ğŸ‡¬ğŸ‡§</span>
            <div>
              <div class="lang-name">English</div>
              <div class="lang-code">Wikipedia: en</div>
            </div>
          </div>
          <span>â†’</span>
        </button>

        <button class="lang-btn" data-lang="de">
          <div class="lang-left">
            <span class="flag">ğŸ‡©ğŸ‡ª</span>
            <div>
              <div class="lang-name">Deutsch</div>
              <div class="lang-code">Wikipedia: de</div>
            </div>
          </div>
          <span>â†’</span>
        </button>
      </div>

      <div style="margin-top:12px; font-size:12px; opacity:.85;" id="langHint">
        Ø³ÙŠØªÙ… ØªØ°ÙƒØ± Ø§Ø®ØªÙŠØ§Ø±Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
      </div>
    </div>
  </div>

  <script>
    // =========================
    // State & DOM
    // =========================
    let isMusicPlayed = false;

    const conversationContainer = document.getElementById('conversation');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    const settingsBtn = document.getElementById('settingsBtn');
    const settingsDrawer = document.getElementById('settingsDrawer');
    const settingsBackdrop = document.getElementById('settingsBackdrop');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');

    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');

    const langModal = document.getElementById('langModal');
    const langPrompt = document.getElementById('langPrompt');
    const changeLangBtn = document.getElementById('changeLangBtn');
    const currentLangLabel = document.getElementById('currentLangLabel');

    const STORAGE_THEME = 'kefotube_science_theme';
    const STORAGE_LANG  = 'kefotube_science_lang';

    // Ù„ØºØ© Ù†ØªØ§Ø¦Ø¬ ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let wikiLang = 'ar';

    // =========================
    // Helpers: Auto-scroll (ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø«Ø§Ø¨Øª)
    // =========================
    function scrollToBottom(smooth = true) {
      const behavior = smooth ? 'smooth' : 'auto';
      conversationContainer.scrollTo({
        top: conversationContainer.scrollHeight,
        behavior
      });
    }

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£ÙŠ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ÙŠØ¶Ù…Ù† Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± Ø³Ø·Ø± Ù…Ø±Ø¦ÙŠ
    const observer = new MutationObserver(() => {
      // Ø£Ø«Ù†Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù‚Ø§Ù„ Ù„Ø§ Ù†Ø±ÙŠØ¯ Ø³Ù„Ø§Ø³Ø© Ù‚Ø¯ ØªØ³Ø¨Ø¨ "Ù‚ÙØ²Ø§Øª" Ø¨ØµØ±ÙŠØ©
      scrollToBottom(false);
    });
    observer.observe(conversationContainer, { childList: true, subtree: true });

    // =========================
    // Theme
    // =========================
    function applyTheme(theme) {
      const isLight = theme === 'light';
      document.body.classList.toggle('theme-light', isLight);
      themeToggle.checked = isLight;
      themeLabel.textContent = isLight ? 'Ù†Ù‡Ø§Ø±ÙŠ' : 'Ù„ÙŠÙ„ÙŠ';
      localStorage.setItem(STORAGE_THEME, theme);
    }

    (function initTheme(){
      const saved = localStorage.getItem(STORAGE_THEME) || 'dark';
      applyTheme(saved);
    })();

    themeToggle.addEventListener('change', () => {
      applyTheme(themeToggle.checked ? 'light' : 'dark');
    });

    // =========================
    // Settings drawer
    // =========================
    function openSettings(){
      settingsDrawer.classList.add('open');
      settingsDrawer.setAttribute('aria-hidden', 'false');
    }
    function closeSettings(){
      settingsDrawer.classList.remove('open');
      settingsDrawer.setAttribute('aria-hidden', 'true');
    }

    settingsBtn.addEventListener('click', openSettings);
    closeSettingsBtn.addEventListener('click', closeSettings);
    settingsBackdrop.addEventListener('click', closeSettings);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeSettings();
        closeLangModal();
      }
    });

    // =========================
    // i18n Ø¨Ø³ÙŠØ· Ù„Ø±Ø³Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù„ØºØ© (Ø­Ø³Ø¨ Ù„ØºØ© Ø§Ù„Ø¬Ù‡Ø§Ø²)
    // =========================
    function getDeviceUILang(){
      const l = (navigator.language || 'en').toLowerCase();
      if (l.startsWith('ar')) return 'ar';
      if (l.startsWith('de')) return 'de';
      return 'en';
    }

    const uiText = {
      ar: {
        langPrompt: "Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø§Ø®ØªØ± Ù„ØºØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬",
        langHint: "Ø³ÙŠØªÙ… ØªØ°ÙƒØ± Ø§Ø®ØªÙŠØ§Ø±Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.",
        inputPlaceholder: "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø¬Ù…Ù„Ø© Ù„Ù„Ø¨Ø­Ø«",
        searchBtn: "Ø¨Ø­Ø«",
        welcomeMsg: "Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø£Ùˆ Ù…ØµØ·Ù„Ø­Ø§Ù‹ØŒ ÙˆØ³Ø£Ø¹Ø±Ø¶ Ù„Ùƒ Ù†ØªØ§Ø¦Ø¬ ÙˆÙŠÙƒÙŠØ¨ÙŠØ¯ÙŠØ§ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.",
        noTerm: "â— ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«",
        searching: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...",
        results: "ğŸ“„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø­):",
        fetching: "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±Ø­...",
        noResults: (t)=>`Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„ÙƒÙ„Ù…Ø©: "${t}"`,
        fetchErr: "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±Ø­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.",
        searchErr: "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø«ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.",
        copied: "âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ!",
        copyFail: "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø®!",
        copyBtn: "Ù†Ø³Ø® Ø§Ù„Ù†ØªÙŠØ¬Ø©",
        signature: "Ø¨Ù‚Ù„Ù… Ø²ÙƒØ±ÙŠØ§ ÙƒÙŠÙÙˆ",
        settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
        mode: "Ø§Ù„ÙˆØ¶Ø¹",
        language: "Ø§Ù„Ù„ØºØ©",
        change: "ØªØºÙŠÙŠØ±",
        close: "Ø¥ØºÙ„Ø§Ù‚",
        dark: "Ù„ÙŠÙ„ÙŠ",
        light: "Ù†Ù‡Ø§Ø±ÙŠ",
        currentLang: (code)=>({ar:"Ø¹Ø±Ø¨ÙŠ",en:"English",de:"Deutsch"}[code]||code)
      },
      en: {
        langPrompt: "Welcome, choose results language",
        langHint: "Your choice will be remembered next time.",
        inputPlaceholder: "Type a word or phrase to search",
        searchBtn: "Search",
        welcomeMsg: "Type a term and I will show Wikipedia results in your selected language.",
        noTerm: "â— Please type a search term",
        searching: "Searching...",
        results: "ğŸ“„ Results (click a title to view the summary):",
        fetching: "ğŸ”„ Fetching summary...",
        noResults: (t)=>`No results for: "${t}"`,
        fetchErr: "âŒ Error fetching summary. Please try again later.",
        searchErr: "âŒ Search error. Please try again later.",
        copied: "âœ… Copied!",
        copyFail: "âŒ Copy failed!",
        copyBtn: "Copy result",
        signature: "By Zakaria KeFo",
        settings: "Settings",
        mode: "Mode",
        language: "Language",
        change: "Change",
        close: "Close",
        dark: "Dark",
        light: "Light",
        currentLang: (code)=>({ar:"Arabic",en:"English",de:"German"}[code]||code)
      },
      de: {
        langPrompt: "Willkommen, wÃ¤hle die Sprache der Ergebnisse",
        langHint: "Deine Auswahl wird beim nÃ¤chsten Ã–ffnen gespeichert.",
        inputPlaceholder: "Begriff oder Satz eingeben",
        searchBtn: "Suchen",
        welcomeMsg: "Gib einen Begriff ein, ich zeige Wikipedia-Ergebnisse in deiner gewÃ¤hlten Sprache.",
        noTerm: "â— Bitte einen Suchbegriff eingeben",
        searching: "Suche lÃ¤uft...",
        results: "ğŸ“„ Ergebnisse (Titel anklicken fÃ¼r Zusammenfassung):",
        fetching: "ğŸ”„ Zusammenfassung wird geladen...",
        noResults: (t)=>`Keine Ergebnisse fÃ¼r: "${t}"`,
        fetchErr: "âŒ Fehler beim Laden. Bitte spÃ¤ter erneut versuchen.",
        searchErr: "âŒ Suchfehler. Bitte spÃ¤ter erneut versuchen.",
        copied: "âœ… Kopiert!",
        copyFail: "âŒ Kopieren fehlgeschlagen!",
        copyBtn: "Ergebnis kopieren",
        signature: "Von Zakaria KeFo",
        settings: "Einstellungen",
        mode: "Modus",
        language: "Sprache",
        change: "Ã„ndern",
        close: "SchlieÃŸen",
        dark: "Dunkel",
        light: "Hell",
        currentLang: (code)=>({ar:"Arabisch",en:"Englisch",de:"Deutsch"}[code]||code)
      }
    };

    let uiLang = getDeviceUILang();

    function t(key, ...args){
      const v = uiText[uiLang][key];
      return typeof v === 'function' ? v(...args) : v;
    }

    function applyUIText(){
      document.getElementById('settingsTitle').textContent = t('settings');
      document.getElementById('themeRowLabel').textContent = t('mode');
      document.getElementById('langRowLabel').textContent = t('language');
      document.getElementById('changeLangBtn').textContent = t('change');
      document.getElementById('closeSettingsBtn').textContent = t('close');
      document.getElementById('langHint').textContent = t('langHint');

      userInput.placeholder = t('inputPlaceholder');
      sendBtn.textContent = t('searchBtn');

      // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ© ÙˆØ¶Ø¹ Ø§Ù„Ø«ÙŠÙ…
      themeLabel.textContent = document.body.classList.contains('theme-light') ? t('light') : t('dark');

      // Ø±Ø³Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„Ù„ØºØ©
      langPrompt.textContent = t('langPrompt');

      // Ø¹Ø±Ø¶ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      currentLangLabel.textContent = t('currentLang', wikiLang);
    }

    // =========================
    // Language selection
    // =========================
    function openLangModal(){
      langModal.classList.add('open');
    }
    function closeLangModal(){
      langModal.classList.remove('open');
    }

    function setWikiLang(langCode){
      wikiLang = langCode;
      localStorage.setItem(STORAGE_LANG, langCode);
      currentLangLabel.textContent = t('currentLang', wikiLang);

      // Ø¶Ø¨Ø· Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙØ­Ø©/Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø­Ø³Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      if (wikiLang === 'ar') {
        document.documentElement.lang = 'ar';
        document.documentElement.dir = 'rtl';
      } else {
        document.documentElement.lang = wikiLang;
        document.documentElement.dir = 'ltr';
      }
      // Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØªØ¨Ù‚Ù‰ RTL ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ØŸ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯Ù‡Ø§ ØªØªØºÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©ØŒ Ø£Ù„ØºÙ Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ:
      conversationContainer.style.direction = (wikiLang === 'ar') ? 'rtl' : 'ltr';
    }

    // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ§Øª
    document.querySelectorAll('.lang-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const lang = btn.getAttribute('data-lang');
        setWikiLang(lang);
        closeLangModal();
        applyUIText();
        showCopyNotification(t('copied')); // Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ± Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸
      });
    });

    // Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    changeLangBtn.addEventListener('click', ()=>{
      closeSettings();
      openLangModal();
    });

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„ØºØ© (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
    (function initLang(){
      const saved = localStorage.getItem(STORAGE_LANG);
      if (saved) {
        setWikiLang(saved);
      } else {
        openLangModal();
      }
    })();

    // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†ØµÙˆØµ
    applyUIText();

    // =========================
    // Wikipedia API Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
    // =========================
    function wikiBase(){
      return `https://${wikiLang}.wikipedia.org/w/api.php`;
    }

    async function searchWikipedia() {
      const searchTerm = userInput.value.trim();
      if (!searchTerm) {
        showCopyNotification(t('noTerm'));
        return;
      }

      if (!isMusicPlayed) {
        const audio = document.getElementById('background-music');
        audio.play().catch(() => {});
        isMusicPlayed = true;
      }

      addMessageToConversation(searchTerm, true);
      addMessageToConversation(t('searching'), false);

      // list=search ÙŠØ¹Ù…Ù„ ÙÙŠ ÙƒÙ„ Ø§Ù„Ù„ØºØ§Øª
      const apiUrl = `${wikiBase()}?action=query&format=json&list=search&srsearch=${encodeURIComponent(searchTerm)}&origin=*`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        displaySearchResults((data.query && data.query.search) ? data.query.search : [], searchTerm);
      } catch (error) {
        console.error("Search error:", error);
        addMessageToConversation(t('searchErr'), false);
      } finally {
        userInput.value = '';
        userInput.focus();
      }
    }

    function displaySearchResults(results, searchTerm) {
      if (!results || results.length === 0) {
        addMessageToConversation(t('noResults', searchTerm), false);
        return;
      }

      addMessageToConversation(t('results'), false);

      results.slice(0, 10).forEach((result, index) => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'message-bubble';
        resultDiv.textContent = `${index + 1}. ${result.title}`;
        resultDiv.style.cursor = 'pointer';
        resultDiv.title = 'Click to fetch summary';
        resultDiv.onclick = () => fetchFullArticle(result.title);
        conversationContainer.appendChild(resultDiv);
      });

      scrollToBottom(false);
    }

    async function fetchFullArticle(title) {
      addMessageToConversation(t('fetching'), false);

      // extracts + explaintext: Ù†Øµ Ù†Ø¸ÙŠÙ Ø¨Ø¯ÙˆÙ† HTML
      const apiUrl = `${wikiBase()}?action=query&format=json&prop=extracts&exintro&explaintext&titles=${encodeURIComponent(title)}&origin=*`;

      try {
        const response = await fetch(apiUrl);
        const data = await response.json();
        const page = Object.values(data.query.pages)[0];
        let extract = page.extract || "No summary found.";

        const articleContainer = document.createElement('div');
        articleContainer.className = 'article-container';

        const typingEffectDiv = document.createElement('div');
        typingEffectDiv.className = 'typing-effect';
        articleContainer.appendChild(typingEffectDiv);

        conversationContainer.appendChild(articleContainer);
        scrollToBottom(false);

        // ÙƒØªØ§Ø¨Ø© Ø­Ø±Ù-Ø¨Ø­Ø±Ù Ù…Ø¹ Ø¥Ø¨Ù‚Ø§Ø¡ Ø¢Ø®Ø± Ø­Ø±Ù Ù…Ø±Ø¦ÙŠØ§Ù‹ØŒ Ø¨Ø¯ÙˆÙ† ØªØ­Ø±ÙŠÙƒ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        let i = 0;
        const speed = 12;
        function typeWriter() {
          if (i < extract.length) {
            typingEffectDiv.textContent += extract.charAt(i);
            i++;
            scrollToBottom(false);
            setTimeout(typeWriter, speed);
          } else {
            const signature = document.createElement('div');
            signature.className = 'signature';
            signature.textContent = t('signature');
            articleContainer.appendChild(signature);

            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn';
            copyBtn.textContent = t('copyBtn');
            copyBtn.onclick = () => copyToClipboard(extract + "\n" + t('signature'));
            articleContainer.appendChild(copyBtn);

            scrollToBottom(true);
          }
        }
        typeWriter();

      } catch (error) {
        console.error("Fetch error:", error);
        addMessageToConversation(t('fetchErr'), false);
      }
    }

    function addMessageToConversation(message, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message-bubble ${isUser ? 'user-bubble' : ''}`;
      messageDiv.textContent = message;
      conversationContainer.appendChild(messageDiv);
      scrollToBottom(false);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => { showCopyNotification(t('copied')); })
        .catch(err => {
          console.error('Copy error:', err);
          showCopyNotification(t('copyFail'));
        });
    }

    function showCopyNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => { notification.remove(); }, 500);
      }, 1800);
    }

    // Events: Ø²Ø± Ø§Ù„Ø¨Ø­Ø« + Enter
    sendBtn.addEventListener('click', searchWikipedia);
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchWikipedia();
    });

    // Ù…Ù†Ø¹ Ø§Ù„Ù†Ø³Ø®
    document.addEventListener("contextmenu", e => e.preventDefault());
    document.addEventListener("selectstart", e => e.preventDefault());
    document.addEventListener("touchstart", e => {
      if (e.touches.length > 1) e.preventDefault();
    }, { passive: false });

    // Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
    addMessageToConversation(t('welcomeMsg'), false);

    // ØªØ­Ø¯ÙŠØ« ØªØ³Ù…ÙŠØ© Ø§Ù„ÙˆØ¶Ø¹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    const themeObserver = new MutationObserver(() => {
      themeLabel.textContent = document.body.classList.contains('theme-light') ? t('light') : t('dark');
    });
    themeObserver.observe(document.body, { attributes: true, attributeFilter: ['class'] });
  </script>
</body>
</html>
